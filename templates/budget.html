{% extends "base.html" %}
{% from "macros/forms.html" import render_field, render_submit %}

{% block title %}Budget - Expense Tracker{% endblock %}

{% block content %}
<div class="budget-container">
    <div class="page-header">
        <h1 class="page-title">💰 Monthly Budget</h1>
        <p class="page-subtitle">Set and track your monthly spending limit</p>
    </div>

    <!-- Budget Overview Cards -->
    <div class="budget-overview">
        <div class="budget-card budget-card-primary">
            <div class="budget-card-icon">🎯</div>
            <div class="budget-card-content">
                <h3>Budget Set</h3>
                <div class="budget-amount">₹{{ "%.2f"|format(budget) }}</div>
            </div>
        </div>

        <div class="budget-card budget-card-danger">
            <div class="budget-card-icon">💸</div>
            <div class="budget-card-content">
                <h3>Total Spent</h3>
                <div class="budget-amount">₹{{ "%.2f"|format(total_expenses) }}</div>
            </div>
        </div>

        <div class="budget-card budget-card-{% if remaining >= 0 %}success{% else %}danger{% endif %}">
            <div class="budget-card-icon">{% if remaining >= 0 %}💰{% else %}⚠️{% endif %}</div>
            <div class="budget-card-content">
                <h3>Remaining</h3>
                <div class="budget-amount">₹{{ "%.2f"|format(remaining) }}</div>
            </div>
        </div>
    </div>

    <!-- Budget Progress Section -->
    {% if budget > 0 %}
    <div class="card budget-progress-card">
        <div class="card-header">
            <h2 class="card-title">📊 Budget Utilization</h2>
            <div class="budget-percentage">{{ "%.1f"|format((total_expenses / budget * 100)) }}%</div>
        </div>
        <div class="card-body">
            <div class="progress-container">
                <div class="progress-bar-container">
                    <div class="progress-bar {% if total_expenses > budget %}progress-bar-danger{% elif total_expenses > budget * 0.8 %}progress-bar-warning{% else %}progress-bar-success{% endif %}"
                        style="width: {{ (total_expenses / budget * 100)|round(1) if (total_expenses / budget * 100) <= 100 else 100 }}%">
                    </div>
                </div>
                <div class="progress-labels">
                    <span class="progress-label">0%</span>
                    <span class="progress-label">50%</span>
                    <span class="progress-label">100%</span>
                </div>
            </div>

            {% if total_expenses > budget %}
            <div class="alert alert-danger">
                <div class="alert-icon">⚠️</div>
                <div class="alert-content">
                    <h4>Overspending Alert!</h4>
                    <p>You've exceeded your budget by ₹{{ "%.2f"|format(total_expenses - budget) }}</p>
                </div>
            </div>
            {% elif total_expenses > budget * 0.8 %}
            <div class="alert alert-warning">
                <div class="alert-icon">⚡</div>
                <div class="alert-content">
                    <h4>Budget Warning</h4>
                    <p>You've used {{ "%.1f"|format((total_expenses / budget * 100)) }}% of your budget</p>
                </div>
            </div>
            {% elif total_expenses > budget * 0.5 %}
            <div class="alert alert-info">
                <div class="alert-icon">📈</div>
                <div class="alert-content">
                    <h4>Good Progress</h4>
                    <p>You're on track with {{ "%.1f"|format((total_expenses / budget * 100)) }}% of your budget used
                    </p>
                </div>
            </div>
            {% else %}
            <div class="alert alert-success">
                <div class="alert-icon">✅</div>
                <div class="alert-content">
                    <h4>Great Start!</h4>
                    <p>You've only used {{ "%.1f"|format((total_expenses / budget * 100)) }}% of your budget</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Set Budget Form -->
    <div class="card budget-form-card">
        <div class="card-header">
            <h2 class="card-title">🎯 Set Monthly Budget</h2>
            <p class="card-subtitle">Configure your monthly spending limit</p>
        </div>
        <div class="card-body">
            <form method="POST" class="budget-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                <div class="form-group budget-input-group">
                    <label for="budget" class="form-label">
                        <span class="label-icon">💰</span>
                        Monthly Budget Amount
                        <span class="required">*</span>
                    </label>
                    <div class="budget-input-container">
                        <div class="currency-symbol">₹</div>
                        <input type="number" id="budget" name="budget" class="budget-input" placeholder="0.00"
                            step="0.01" min="0" max="999999.99" value="{{ budget if budget > 0 else '' }}" required>
                    </div>
                    <div class="form-help">
                        <span class="help-icon">💡</span>
                        Enter your monthly spending limit to track your expenses
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large">
                        <span class="btn-icon">💰</span>
                        Update Budget
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline btn-large">
                        <span class="btn-icon">↩️</span>
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Tips & Guidelines -->
    <div class="budget-tips-section">
        <div class="tips-grid">
            <!-- Smart Budgeting Tips -->
            <div class="tip-card tip-card-primary">
                <div class="tip-header">
                    <div class="tip-icon">💡</div>
                    <h3>Smart Budgeting</h3>
                </div>
                <div class="tip-content">
                    <ul class="tip-list">
                        <li class="tip-item">
                            <span class="tip-bullet">🎯</span>
                            Set realistic monthly limits
                        </li>
                        <li class="tip-item">
                            <span class="tip-bullet">📱</span>
                            Track expenses daily
                        </li>
                        <li class="tip-item">
                            <span class="tip-bullet">📊</span>
                            Review and adjust regularly
                        </li>
                        <li class="tip-item">
                            <span class="tip-bullet">📈</span>
                            Use the 50/30/20 rule
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Category Guidelines -->
            <div class="tip-card tip-card-secondary">
                <div class="tip-header">
                    <div class="tip-icon">📊</div>
                    <h3>Category Guidelines</h3>
                </div>
                <div class="tip-content">
                    <ul class="tip-list">
                        <li class="tip-item">
                            <span class="tip-category">🍕</span>
                            <span class="tip-text">Food: 30-40%</span>
                        </li>
                        <li class="tip-item">
                            <span class="tip-category">🚗</span>
                            <span class="tip-text">Transportation: 10-15%</span>
                        </li>
                        <li class="tip-item">
                            <span class="tip-category">⚡</span>
                            <span class="tip-text">Utilities: 5-10%</span>
                        </li>
                        <li class="tip-item">
                            <span class="tip-category">🎬</span>
                            <span class="tip-text">Entertainment: 5-10%</span>
                        </li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Add currency formatting to budget input
        const budgetInput = document.getElementById('budget');
        if (budgetInput) {
            budgetInput.addEventListener('input', function () {
                // Ensure positive values only
                if (this.value < 0) {
                    this.value = 0;
                }
            });
        }
    });
</script>
{% endblock %}